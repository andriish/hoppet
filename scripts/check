#!/bin/bash
#
# Script that runs a quick check that the results are sensible
# 
# Run it from the top-level directory as scripts/check
#
# Created by GPS on 2009-09-05 and subsequently adapted by AK.
#----------------------------------------------------------------------

# list of tests to run:
# - for a test labelled $test, there should be a reference output file
#   $test.default_output

# if any arguments are given, run only those tests
# otherwise run all tests
if [ $# -gt 0 ]; then
  tests=("$@")
else
  # if no arguments are given, run all tests
  echo "No arguments given, running all tests."

  tests=(example_f90/tabulation_example \
         example_f90/tabulation_example_qed \
         example_f90/tabulation_example_qed_streamlined \
         example_f90/tabulation_example_n3lo \
         example_f90/structure_functions_example \
         example_f90/structure_functions_example_flavour \
         )
       #example_f90/tabulation_example_up_and_down
fi

for test in ${tests[@]}; do
  echo
  echo '*****************************************************************'
  echo '    ' Doing check with $test
  echo '*****************************************************************'
  echo 
  checkname=$(echo $test | sed 's|/|_|g')
  ($test | tee ${checkname}.tmp.new-pregrep) || exit 1;
  
  grep -vi -e '^ *[a-z]' -e '^ *$' ${checkname}.tmp.new-pregrep > ${checkname}.tmp.new
  grep -vi -e '^ *[a-z]' -e '^ *$' $test.default_output > ${checkname}.tmp.orig  

  diff ${checkname}.tmp.new ${checkname}.tmp.orig > ${checkname}.tmp.diff
  checkwc=`cat ${checkname}.tmp.diff| wc -l `
  
  echo
  if [ $checkwc == "0" ] 
  then
    echo check PASSED
    rm -f ${checkname}.tmp.new ${checkname}.tmp.orig ${checkname}.tmp.diff ${checkname}.tmp.new-pregrep
  else
    echo check FAILED: look at '${checkname}.tmp.*' to see differences
    exit 1;
  fi
  
done

echo "All tests passed!"
